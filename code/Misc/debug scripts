#!/bin/bash
# compact debug helper: build/test/debug/stress
# Install: mkdir -p ~/bin && chmod +x ~/bin/* && add to PATH

build(){ # build <name> [flags]
  g++ -std=gnu++17 -Wall -O2 -g -fsanitize=undefined,address $2 "$1.cpp" -o "$1"
}

test_all(){ # test <name>
  build "$1" || return 1
  for IN in "$1".in*; do
    echo "=== $IN ==="; cat "$IN"
    echo "--- OUTPUT ---"; ./$1 < "$IN"
  done
}

debug(){ # debug <name>
  build "$1" -DSMIE || return 1
  ./$1
}

stress(){ # stress <name>
  build "$1" || return 1
  build "${1}_gen" || return 1
  build "${1}_brute" || return 1
  i=0
  while true; do ((i++)); echo "Test $i"
    ./${1}_gen "$i" > inp
    ./$1 < inp > out1
    ./${1}_brute < inp > out2
    if ! diff -w out1 out2 >/dev/null; then
      echo "FAILED on test $i"; cat inp; echo "Your:"; cat out1; echo "Exp:"; cat out2
      break
    fi
  done
}

# Quick: build name | test name | debug name | stress name

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  cmd="$1"; shift || true
  case "$cmd" in
    build) build "$@" ;;
    test) test_all "$@" ;;
    debug) debug "$@" ;;
    stress) stress "$@" ;;
    *) echo "Usage: $0 {build|test|debug|stress} name" ;;
  esac
fi